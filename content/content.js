(() => {
  const TEMPY_ATTR = "data-tempy-attached";
  const ICON_SIZE = 20;
  const i18n = (key, substitutions) => chrome.i18n.getMessage(key, substitutions) || key;

  // SVG icons
  const TRASH_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>`;
  const OPEN_SVG = `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#3498db" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>`;

  const ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 437 437" width="${ICON_SIZE}" height="${ICON_SIZE}">
<path d="M0 0 C144.21 0 288.42 0 437 0 C437 144.21 437 288.42 437 437 C292.79 437 148.58 437 0 437 C0 292.79 0 148.58 0 0 Z " fill="#F5721D"/>
<path d="M0 0 C144.21 0 288.42 0 437 0 C437 144.21 437 288.42 437 437 C292.79 437 148.58 437 0 437 C0 292.79 0 148.58 0 0 Z M180 9 C178.48575439 9.29813599 178.48575439 9.29813599 176.94091797 9.60229492 C139.01845111 17.38081022 105.67546642 35.89660357 77.2890625 61.95703125 C75.70978981 63.36651865 74.08164523 64.72245761 72.41796875 66.03125 C70.23963527 67.80488502 68.49434682 69.54887485 66.6875 71.6875 C64.88905509 73.80240946 63.09589214 75.8978811 61.1953125 77.921875 C22.64547853 119.19099186 7.60262637 175.8651648 9 231 C11.05468789 280.35427139 31.49323014 327.4545493 64.81640625 363.62890625 C66.32291734 365.26477786 67.80880993 366.91979585 69.27734375 368.58984375 C70.40849609 369.87568359 70.40849609 369.87568359 71.5625 371.1875 C72.22378906 371.94417969 72.88507813 372.70085937 73.56640625 373.48046875 C109.87396663 411.07015807 164.18724799 432.1312692 215.828125 433.125 C250.36620959 433.57776638 296.25038903 429.60496286 323 405 C325.99274007 399.81258389 327.07131119 394.88210482 326 389 C323.67558048 383.37768612 320.37291862 379.92006447 315 377 C305.99717285 373.99905762 299.0881541 377.64231053 290.8125 381.25 C279.37935819 386.16373607 268.03982657 390.50011317 255.75 392.6875 C254.48671875 392.91824219 253.2234375 393.14898437 251.921875 393.38671875 C242.50911143 394.85863497 233.32595092 395.1862803 223.8190918 395.18530273 C221.46709629 395.18747269 219.11558379 395.20563241 216.76367188 395.22460938 C202.97025938 395.27783574 189.58129457 394.17588083 176.25 390.375 C175.32735352 390.11557617 174.40470703 389.85615234 173.45410156 389.58886719 C127.09024845 376.11818129 90.13312302 345.75972182 66.41308594 303.8984375 C44.69942067 263.9776616 39.0269446 213.72590907 51.6953125 170.00390625 C65.80916345 123.93562118 96.27465793 84.73317037 139.08203125 61.98828125 C154.21804662 54.20759392 170.26838726 48.26785431 187 45 C187.90000732 44.81775879 188.80001465 44.63551758 189.72729492 44.44775391 C200.0275159 42.59876285 210.31829665 42.56204807 220.75 42.5625 C221.69965637 42.56076782 222.64931274 42.55903564 223.62774658 42.55725098 C238.96765944 42.5695273 253.17205392 43.79994299 268 48 C269.3215753 48.34910708 270.64318593 48.69808044 271.96484375 49.046875 C275.03236026 49.92024026 278.00709756 50.90074172 281 52 C281.86753906 52.309375 282.73507812 52.61875 283.62890625 52.9375 C301.14868619 59.71613463 317.54017427 69.046129 332 81 C332.61166016 81.495 333.22332031 81.99 333.85351562 82.5 C368.37222643 110.49405481 390.80578534 151.92005079 396.55859375 195.9609375 C397.27355906 202.82634476 397.28868212 209.72894374 397.3125 216.625 C397.31511841 217.35176941 397.31773682 218.07853882 397.32043457 218.82733154 C397.32545091 231.88880372 395.98857507 244.25882121 393 257 C392.8345166 257.73895508 392.6690332 258.47791016 392.49853516 259.23925781 C390.59613161 267.62845022 387.85242417 275.30635056 384 283 C383.30390625 284.49853516 383.30390625 284.49853516 382.59375 286.02734375 C377.45124968 296.87309576 371.12146757 304.91323745 361.375 311.875 C355.65937558 313.78020814 348.43160727 314.69075541 342.859375 311.9453125 C339.49172276 309.18252984 338.10852718 307.0946507 337.68359375 302.80859375 C338.05424132 298.34709522 339.62677025 295.66823946 342.0625 292.0625 C355.5801258 270.78850959 362.58710394 246.65655889 362.39111328 221.51196289 C362.37503587 219.06795276 362.39105707 216.62560102 362.41015625 214.18164062 C362.42903746 200.72171011 360.77865556 187.82964169 356.3125 175.0625 C356.05903809 174.32435059 355.80557617 173.58620117 355.54443359 172.82568359 C349.28457992 155.15013996 340.19726261 140.25514874 328 126 C327.31808594 125.19433594 326.63617188 124.38867188 325.93359375 123.55859375 C321.6246779 118.57509225 317.10904963 114.15489775 312 110 C311.06542969 109.22785156 310.13085938 108.45570312 309.16796875 107.66015625 C279.95119742 84.01572701 242.33463729 73.66954018 205.0703125 77.28417969 C180.17310809 80.49978123 155.55093223 90.07828273 136 106 C135.48244141 106.41894531 134.96488281 106.83789062 134.43164062 107.26953125 C108.79249008 128.12952008 90.36057708 154.61032885 83.3125 187.3125 C82.99442383 188.7365918 82.99442383 188.7365918 82.66992188 190.18945312 C82.09476538 192.7894508 81.5419525 195.39290893 81 198 C80.79246094 198.98226562 80.58492188 199.96453125 80.37109375 200.9765625 C76.08278685 235.91497874 85.68675335 273.98889572 106.4375 302.4375 C111.30543951 308.58692888 116.59754518 314.32215768 122 320 C122.64324219 320.70769531 123.28648438 321.41539062 123.94921875 322.14453125 C145.32375205 344.91003201 179.19460081 359.1561348 210.08520508 361.20458984 C213.2474507 361.30251681 216.39880756 361.32900872 219.5625 361.3125 C220.69292725 361.30758545 221.82335449 361.3026709 222.98803711 361.29760742 C252.0043632 360.89714146 282.78217017 351.5213842 305.8125 333.375 C306.864375 332.59125 307.91625 331.8075 309 331 C312 332 312 332 314.3125 335.0625 C320.97784616 343.1040246 332.79121464 348.63167397 343 350 C360.4236914 351.24837093 376.02462247 347.10217076 390.1484375 336.67578125 C412.01674147 317.65586981 422.76261356 288.71275965 429.125 261.1875 C429.36331543 260.17598877 429.36331543 260.17598877 429.60644531 259.14404297 C432.73559081 244.9706608 433.44273142 230.77231737 433.4375 216.3125 C433.43823517 215.42114349 433.43897034 214.52978699 433.43972778 213.61141968 C433.38761028 189.38704019 429.34927348 166.80450112 421 144 C420.62488281 142.94039062 420.24976563 141.88078125 419.86328125 140.7890625 C411.96582175 120.29676981 400.14842058 100.75071936 386 84 C385.55398438 83.4652002 385.10796875 82.93040039 384.6484375 82.37939453 C374.63152216 70.37717479 364.18999754 59.75567995 351.71533203 50.30517578 C350.12060586 49.09176757 348.54200464 47.85724688 346.96484375 46.62109375 C324.75296822 29.43155347 298.32934115 17.20163203 271 11 C269.79988281 10.7215625 268.59976562 10.443125 267.36328125 10.15625 C252.67337631 6.8662377 238.71693316 5.65073753 223.70654297 5.68432617 C220.76882544 5.68747979 217.83212471 5.66396632 214.89453125 5.63867188 C202.94481248 5.59836251 191.70036984 6.58814008 180 9 Z " fill="#FDFDFC"/>
<path d="M0 0 C1.30177428 0.43325667 2.60525679 0.86140515 3.91015625 1.28515625 C30.36856188 10.16062477 51.21123125 29.10778613 63.95751953 53.859375 C75.03368469 76.20472922 78.91623446 105.26942459 71.328125 129.4765625 C70.88984375 130.63929688 70.4515625 131.80203125 70 133 C69.74798828 133.69577148 69.49597656 134.39154297 69.23632812 135.10839844 C64.45274826 148.19154671 57.84513439 159.22248264 49 170 C48.46890625 170.66644531 47.9378125 171.33289063 47.390625 172.01953125 C35.98231676 185.79098905 20.44518504 194.59905894 4 201 C3.24589844 201.30679688 2.49179688 201.61359375 1.71484375 201.9296875 C-23.23763799 211.2568194 -50.98632162 207.91514651 -74.87109375 197.33203125 C-100.98475335 184.83294117 -120.22596176 162.94127849 -130.10302734 135.88037109 C-139.28862925 109.24409813 -138.31388405 80.40103235 -126.01367188 54.96533203 C-112.71830809 29.18795282 -90.99432066 9.38830083 -63.3203125 0.43359375 C-43.68118433 -5.59171889 -19.5346685 -7.52776541 0 0 Z " fill="#FDFDFC" transform="translate(252,118)"/>
<path d="M0 0 C2 0.3125 2 0.3125 4 1 C5.62536986 4.25073972 5.48916549 7.86497321 5.75390625 11.4453125 C5.85166603 12.7110762 5.85166603 12.7110762 5.95140076 14.00241089 C6.08868653 15.79279415 6.22388686 17.58333834 6.35717773 19.37402344 C6.56015228 22.09354445 6.77075218 24.81239353 6.98242188 27.53125 C7.11504342 29.27340254 7.24721877 31.01558911 7.37890625 32.7578125 C7.47263268 33.966082 7.47263268 33.966082 7.56825256 35.19876099 C7.93175958 40.14757065 8.05628472 45.03774083 8 50 C8.598125 50.2475 9.19625 50.495 9.8125 50.75 C12.39641917 52.22652524 13.4414855 53.46960287 15 56 C15.87570205 61.22265547 15.61426036 65.7259785 13.3125 70.5 C9.6369874 74.47352714 6.98193241 76.15561677 1.5625 76.4375 C-2.97263767 76.26423062 -5.54839344 75.05025696 -9 72 C-12.67320146 67.84348256 -13.64056179 64.58715347 -13.39453125 59.18359375 C-12.77792243 55.77087762 -11.22190343 53.60280116 -9 51 C-8.01 50.34 -7.02 49.68 -6 49 C-5.3795482 46.88236137 -5.3795482 46.88236137 -5.21630859 44.38256836 C-5.11965912 43.42495102 -5.02300964 42.46733368 -4.9234314 41.48069763 C-4.83268341 40.44421585 -4.74193542 39.40773407 -4.6484375 38.33984375 C-4.54407379 37.27963516 -4.43971008 36.21942657 -4.33218384 35.12709045 C-4.00009789 31.73166859 -3.68674897 28.33484438 -3.375 24.9375 C-3.05289904 21.53698621 -2.72693326 18.1369016 -2.39639282 14.73719788 C-2.19150154 12.6187896 -1.99214515 10.49983775 -1.79867554 8.38035583 C-1.70833038 7.42589066 -1.61798523 6.47142548 -1.52490234 5.48803711 C-1.44734711 4.64357529 -1.36979187 3.79911346 -1.28988647 2.92906189 C-1 1 -1 1 0 0 Z " fill="#EC5F1F" transform="translate(220,158)"/>
<path d="M0 0 C0.78052734 0.00322266 1.56105469 0.00644531 2.36523438 0.00976562 C3.53022461 -0.0144043 3.53022461 -0.0144043 4.71875 -0.0390625 C10.44156935 -0.04399172 10.44156935 -0.04399172 12.68969727 1.6496582 C13.92773438 3.32226562 13.92773438 3.32226562 13.67773438 6.44726562 C12.92773438 9.32226562 12.92773438 9.32226562 11.92773438 10.32226562 C8.7903067 10.59913449 5.6384416 10.55400191 2.49023438 10.57226562 C1.60529297 10.59289062 0.72035156 10.61351562 -0.19140625 10.63476562 C-1.46081055 10.6425 -1.46081055 10.6425 -2.75585938 10.65039062 C-3.53501709 10.65973633 -4.3141748 10.66908203 -5.11694336 10.67871094 C-5.76219971 10.56108398 -6.40745605 10.44345703 -7.07226562 10.32226562 C-9.07226562 7.32226562 -9.07226562 7.32226562 -8.82226562 4.75976562 C-7.29840092 -0.19279467 -4.75538389 0.04513307 0 0 Z " fill="#EC6325" transform="translate(136.072265625,213.677734375)"/>
<path d="M0 0 C2.4375 0.3125 2.4375 0.3125 4.4375 2.3125 C4.68041992 4.26782227 4.68041992 4.26782227 4.66796875 6.62890625 C4.66603516 7.47517578 4.66410156 8.32144531 4.66210938 9.19335938 C4.64986328 10.07830078 4.63761719 10.96324219 4.625 11.875 C4.62435547 12.76380859 4.62371094 13.65261719 4.62304688 14.56835938 C4.57771097 21.17228903 4.57771097 21.17228903 3.4375 22.3125 C0 22.5 0 22.5 -3.5625 22.3125 C-6.17292212 19.70207788 -5.85096788 17.80128815 -5.88476562 14.24023438 C-5.88154297 13.45970703 -5.87832031 12.67917969 -5.875 11.875 C-5.89111328 11.09833984 -5.90722656 10.32167969 -5.92382812 9.52148438 C-5.92877626 3.77669495 -5.92877626 3.77669495 -4.19995117 1.58569336 C-2.5625 0.3125 -2.5625 0.3125 0 0 Z " fill="#EC642A" transform="translate(221.5625,290.6875)"/>
<path d="M0 0 C3.4375 0.1875 3.4375 0.1875 4.4375 1.1875 C4.68716567 4.3257345 4.62271791 7.47799613 4.625 10.625 C4.63724609 11.50994141 4.64949219 12.39488281 4.66210938 13.30664062 C4.66500977 14.57604492 4.66500977 14.57604492 4.66796875 15.87109375 C4.67207764 16.65025146 4.67618652 17.42940918 4.68041992 18.23217773 C4.4375 20.1875 4.4375 20.1875 2.4375 22.1875 C0 22.5 0 22.5 -2.5625 22.1875 C-4.19995117 20.91430664 -4.19995117 20.91430664 -5.5625 19.1875 C-5.83341929 16.24817135 -5.93581824 13.55643917 -5.875 10.625 C-5.87822266 9.84447266 -5.88144531 9.06394531 -5.88476562 8.25976562 C-5.80927455 0.30575129 -5.80927455 0.30575129 0 0 Z " fill="#EE6A26" transform="translate(221.5625,125.8125)"/>
<path d="M0 0 C1.08667969 -0.01740234 1.08667969 -0.01740234 2.1953125 -0.03515625 C7.44638026 -0.0060913 7.44638026 -0.0060913 9.98046875 1.73828125 C11.42793592 4.06199292 11.34360727 5.69486333 11 8.375 C8.63431778 10.74068222 8.14767774 10.63071704 4.9375 10.640625 C3.74253906 10.64449219 3.74253906 10.64449219 2.5234375 10.6484375 C1.69070313 10.64070312 0.85796875 10.63296875 0 10.625 C-0.83273437 10.63273438 -1.66546875 10.64046875 -2.5234375 10.6484375 C-3.32007813 10.64585937 -4.11671875 10.64328125 -4.9375 10.640625 C-5.66839844 10.63836914 -6.39929688 10.63611328 -7.15234375 10.63378906 C-9 10.375 -9 10.375 -11 8.375 C-11.34360727 5.69486333 -11.42793592 4.06199292 -9.98046875 1.73828125 C-6.88215581 -0.39448249 -3.62478627 -0.05804818 0 0 Z " fill="#EF6B27" transform="translate(304,213.625)"/>
<path d="M0 0 C1.65 0.33 3.3 0.66 5 1 C4.42176904 5.06225548 3.10882263 7.84762346 0.9375 11.3125 C0.38964844 12.19550781 -0.15820312 13.07851562 -0.72265625 13.98828125 C-1.14417969 14.65214844 -1.56570313 15.31601563 -2 16 C-3.65 15.67 -5.3 15.34 -7 15 C-6.42176904 10.93774452 -5.10882263 8.15237654 -2.9375 4.6875 C-2.38964844 3.80449219 -1.84179688 2.92148438 -1.27734375 2.01171875 C-0.64505859 1.01591797 -0.64505859 1.01591797 0 0 Z " fill="#F1762A" transform="translate(264,139)"/>
<path d="M0 0 C0.53109375 0.23589844 1.0621875 0.47179687 1.609375 0.71484375 C1.609375 2.03484375 1.609375 3.35484375 1.609375 4.71484375 C-0.65625 6.671875 -0.65625 6.671875 -3.640625 8.52734375 C-4.61515625 9.15253906 -5.5896875 9.77773438 -6.59375 10.421875 C-9.390625 11.71484375 -9.390625 11.71484375 -11.75 11.4140625 C-12.29140625 11.18332031 -12.8328125 10.95257813 -13.390625 10.71484375 C-13.720625 9.39484375 -14.050625 8.07484375 -14.390625 6.71484375 C-12.48335749 5.51230559 -10.5644238 4.32825426 -8.640625 3.15234375 C-7.57328125 2.49105469 -6.5059375 1.82976562 -5.40625 1.1484375 C-2.390625 -0.28515625 -2.390625 -0.28515625 0 0 Z " fill="#ED6527" transform="translate(155.390625,255.28515625)"/>
<path d="M0 0 C3.52541563 1.31498629 6.64327136 2.84627321 9.8125 4.875 C10.60269531 5.36742187 11.39289063 5.85984375 12.20703125 6.3671875 C12.79871094 6.90601563 13.39039063 7.44484375 14 8 C14 9.32 14 10.64 14 12 C7.32646591 11.71601983 3.28922815 8.92194468 -2 5 C-1.125 1.125 -1.125 1.125 0 0 Z " fill="#F06B25" transform="translate(143,171)"/>
<path d="M0 0 C1.65 0.33 3.3 0.66 5 1 C4.41892368 4.7602985 3.34800504 7.53035032 1.4375 10.8125 C0.98246094 11.60269531 0.52742187 12.39289063 0.05859375 13.20703125 C-0.46541016 14.09455078 -0.46541016 14.09455078 -1 15 C-2.65 15 -4.3 15 -6 15 C-5.61471495 8.83543922 -3.52913975 5.01372252 0 0 Z " fill="#EF6324" transform="translate(180,284)"/>
<path d="M0 0 C3.31050103 0.28811528 4.63435458 0.57289503 6.8359375 3.14453125 C7.34382813 4.02496094 7.85171875 4.90539062 8.375 5.8125 C9.16003906 7.12154297 9.16003906 7.12154297 9.9609375 8.45703125 C11.09401878 11.23009859 11.08358516 12.26554097 10 15 C6.68949897 14.71188472 5.36564542 14.42710497 3.1640625 11.85546875 C2.65617187 10.97503906 2.14828125 10.09460938 1.625 9.1875 C1.10164063 8.31480469 0.57828125 7.44210937 0.0390625 6.54296875 C-1.09401878 3.76990141 -1.08358516 2.73445903 0 0 Z " fill="#EF6222" transform="translate(258,284)"/>
<path d="M0 0 C2.91844227 0.33062963 3.83593552 0.80091052 5.73828125 3.109375 C6.51751953 4.41648438 6.51751953 4.41648438 7.3125 5.75 C8.11107422 7.04164063 8.11107422 7.04164063 8.92578125 8.359375 C10.16960483 11.4169195 9.95576819 12.89235607 9 16 C6.08155773 15.66937037 5.16406448 15.19908948 3.26171875 12.890625 C2.74222656 12.01921875 2.22273437 11.1478125 1.6875 10.25 C0.88892578 8.95835937 0.88892578 8.95835937 0.07421875 7.640625 C-1.16960483 4.5830805 -0.95576819 3.10764393 0 0 Z " fill="#F06E26" transform="translate(175,139)"/>
<path d="M0 0 C5.83752107 0.29936005 10.79800768 3.01277618 15 7 C15 8.32 15 9.64 15 11 C8.32646591 10.71601983 4.28922815 7.92194468 -1 4 C-0.67 2.68 -0.34 1.36 0 0 Z " fill="#F16B26" transform="translate(286,255)"/>
<path d="M0 0 C0 1.32 0 2.64 0 4 C-2.01171875 5.703125 -2.01171875 5.703125 -4.6875 7.25 C-5.55761719 7.77078125 -6.42773438 8.2915625 -7.32421875 8.828125 C-10.13765556 10.06028711 -11.96737202 10.24042456 -15 10 C-15.29296875 7.7109375 -15.29296875 7.7109375 -15 5 C-12.98828125 3.1640625 -12.98828125 3.1640625 -10.3125 1.625 C-9.44238281 1.10164062 -8.57226562 0.57828125 -7.67578125 0.0390625 C-4.60669489 -1.1527287 -3.10269992 -0.95037655 0 0 Z " fill="#F16F23" transform="translate(301,173)"/>
</svg>`;

  let settingsCache = { autoDetectInputs: true };

  // Load settings
  chrome.runtime.sendMessage({ action: "getSettings" }, (settings) => {
    if (settings) settingsCache = settings;
    if (settingsCache.autoDetectInputs !== false) {
      scanAndAttach();
      observeDom();
    }
  });

  // Listen for settings changes
  chrome.storage.onChanged.addListener((changes) => {
    if (changes.settings) {
      settingsCache = changes.settings.newValue || settingsCache;
      if (settingsCache.autoDetectInputs === false) {
        removeAllOverlays();
      } else {
        scanAndAttach();
      }
    }
  });

  function isEmailInput(input) {
    if (input.type === "email") return true;
    if (input.type !== "text" && input.type !== "") return false;
    const name = (input.name || "").toLowerCase();
    const id = (input.id || "").toLowerCase();
    const placeholder = (input.placeholder || "").toLowerCase();
    const autocomplete = (input.autocomplete || "").toLowerCase();
    return (
      name.includes("email") ||
      id.includes("email") ||
      placeholder.includes("email") ||
      autocomplete === "email"
    );
  }

  function findEmailInputs() {
    return [...document.querySelectorAll("input")].filter(
      (input) => isEmailInput(input) && !input.hasAttribute(TEMPY_ATTR) && isVisible(input)
    );
  }

  function isVisible(el) {
    const rect = el.getBoundingClientRect();
    if (rect.width === 0 || rect.height === 0) return false;
    const style = getComputedStyle(el);
    return style.display !== "none" && style.visibility !== "hidden" && style.opacity !== "0";
  }

  function scanAndAttach() {
    if (settingsCache.autoDetectInputs === false) return;
    for (const input of findEmailInputs()) {
      attachOverlay(input);
    }
  }

  function createIconSvg() {
    const parser = new DOMParser();
    const doc = parser.parseFromString(ICON_SVG, "image/svg+xml");
    return doc.documentElement;
  }

  function attachOverlay(input) {
    input.setAttribute(TEMPY_ATTR, "true");

    // Create shadow host
    const host = document.createElement("div");
    host.className = "tempy-overlay-host";
    host.style.cssText = "position:absolute;z-index:2147483647;pointer-events:none;";

    const shadow = host.attachShadow({ mode: "closed" });
    const style = document.createElement("style");
    style.textContent = `
      :host { position: absolute; z-index: 2147483647; }
      .tempy-container {
        display: flex;
        gap: 2px;
        pointer-events: auto;
      }
      .tempy-btn {
        all: initial;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px;
        height: 28px;
        cursor: pointer;
        border-radius: 4px;
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #e0e0e0;
        pointer-events: auto;
        transition: all 0.15s;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      }
      .tempy-btn:hover {
        border-color: #ff6b35;
        background: #fff5f0;
        box-shadow: 0 1px 4px rgba(255,107,53,0.2);
      }
      .tempy-btn:active {
        transform: scale(0.95);
      }
      .tempy-btn.loading {
        opacity: 0.5;
        pointer-events: none;
      }
      .tempy-btn.success svg {
        stroke: #27ae60;
      }
      .tempy-btn.tempy-trash:hover {
        border-color: #e74c3c;
        background: #fef5f5;
        box-shadow: 0 1px 4px rgba(231,76,60,0.2);
      }
      .tempy-btn.tempy-open:hover {
        border-color: #3498db;
        background: #f0f7ff;
        box-shadow: 0 1px 4px rgba(52,152,219,0.2);
      }
    `;

    const container = document.createElement("div");
    container.className = "tempy-container";

    const btn = document.createElement("button");
    btn.className = "tempy-btn";
    const generateTitle = i18n("generate_tempy_email");
    btn.title = generateTitle;
    btn.setAttribute("aria-label", generateTitle);
    btn.appendChild(createIconSvg());

    container.appendChild(btn);
    shadow.append(style, container);

    function showActionButtons(webUrl) {
      container.innerHTML = "";

      const trashBtn = document.createElement("button");
      trashBtn.className = "tempy-btn tempy-trash";
      const newTitle = i18n("content_new_email");
      trashBtn.title = newTitle;
      trashBtn.setAttribute("aria-label", newTitle);
      trashBtn.innerHTML = TRASH_SVG;

      const openBtn = document.createElement("button");
      openBtn.className = "tempy-btn tempy-open";
      const openTitle = i18n("content_open_inbox");
      openBtn.title = openTitle;
      openBtn.setAttribute("aria-label", openTitle);
      openBtn.innerHTML = OPEN_SVG;

      trashBtn.addEventListener("click", async (e) => {
        e.preventDefault();
        e.stopPropagation();
        trashBtn.classList.add("loading");
        try {
          const resp = await chrome.runtime.sendMessage({ action: "generateEmail" });
          if (resp.ok) {
            fillInput(input, resp.data.email);
            showActionButtons(resp.data.web_url);
          } else {
            trashBtn.classList.remove("loading");
            console.error("[tempy]", resp.error);
          }
        } catch (err) {
          trashBtn.classList.remove("loading");
          console.error("[tempy]", err);
        }
      });

      openBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        window.open(webUrl, "_blank");
      });

      container.append(trashBtn, openBtn);
    }

    btn.addEventListener("click", async (e) => {
      e.preventDefault();
      e.stopPropagation();

      btn.classList.add("loading");

      try {
        const resp = await chrome.runtime.sendMessage({ action: "generateEmail" });
        if (resp.ok) {
          fillInput(input, resp.data.email);
          showActionButtons(resp.data.web_url);
        } else {
          btn.classList.remove("loading");
          console.error("[tempy]", resp.error);
        }
      } catch (err) {
        btn.classList.remove("loading");
        console.error("[tempy]", err);
      }
    });

    document.body.appendChild(host);
    positionOverlay(host, input);

    // Reposition on scroll/resize
    const reposition = () => positionOverlay(host, input);
    const observer = new IntersectionObserver((entries) => {
      host.style.display = entries[0].isIntersecting ? "" : "none";
    });
    observer.observe(input);

    window.addEventListener("scroll", reposition, { passive: true });
    window.addEventListener("resize", reposition, { passive: true });

    // Clean up if input is removed
    const mutObs = new MutationObserver(() => {
      if (!document.contains(input)) {
        host.remove();
        mutObs.disconnect();
        observer.disconnect();
        window.removeEventListener("scroll", reposition);
        window.removeEventListener("resize", reposition);
      }
    });
    mutObs.observe(document.body, { childList: true, subtree: true });
  }

  function positionOverlay(host, input) {
    const rect = input.getBoundingClientRect();
    const scrollX = window.scrollX;
    const scrollY = window.scrollY;

    host.style.top = `${rect.top + scrollY + (rect.height - 28) / 2}px`;
    host.style.left = `${rect.right + scrollX + 4}px`;
  }

  function fillInput(input, email) {
    const setter =
      Object.getOwnPropertyDescriptor(HTMLInputElement.prototype, "value")?.set;

    if (setter) {
      setter.call(input, email);
    } else {
      input.value = email;
    }

    input.dispatchEvent(new Event("input", { bubbles: true }));
    input.dispatchEvent(new Event("change", { bubbles: true }));
    input.focus();
  }

  function removeAllOverlays() {
    document.querySelectorAll(".tempy-overlay-host").forEach((el) => el.remove());
    document.querySelectorAll(`[${TEMPY_ATTR}]`).forEach((el) => {
      el.removeAttribute(TEMPY_ATTR);
    });
  }

  function observeDom() {
    const observer = new MutationObserver((mutations) => {
      let hasNewNodes = false;
      for (const mutation of mutations) {
        if (mutation.addedNodes.length > 0) {
          hasNewNodes = true;
          break;
        }
      }
      if (hasNewNodes) {
        // Debounce: wait for DOM to settle
        clearTimeout(observeDom._timeout);
        observeDom._timeout = setTimeout(scanAndAttach, 300);
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }
})();
